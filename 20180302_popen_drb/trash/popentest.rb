require 'open3'

Open3.popen3("irb") do |stdin, stdout, stderr, wait_thr|
  stdin.puts "def foo"
  stdin.puts "end"
  stdin.puts "q {1 + 2}"
  stdin.close
  p stdout.read
  p stderr.read
end
